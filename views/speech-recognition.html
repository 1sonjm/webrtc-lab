<% include global/header.html %>

<style>
  #result {
    margin-bottom: 20px; padding: 10px 20px; height: 150px;  
    border: solid 1px #000; border-radius: 6px;
  }
</style>

<div id="content">
  <div class="wrap">
    <p>[Start] 버튼을 누른 후 마이크에 이야기를 해보세요.</p>
    <div id="result">
      <span class="final" id="final_span"></span> 
      <span class="interim" id="interim_span"></span>
    </div>
    <button id="start">Start</button>
  </div>
</div>

<script>
  $(function() {
    if (typeof webkitSpeechRecognition != 'function') {
      alert('크롬에서만 동작 합니다.');
      return false;
    }
    
    var recognition = new webkitSpeechRecognition();
    var isRecognizing = false;
    var ignore_onend = false;
    var final_transcript = '';
    
    recognition.continuous = true;
    recognition.interimResults = true;
    
    recognition.onstart = function() {
      console.log('onstart', arguments);
      isRecognizing = true;
    };
  
    recognition.onend = function() {
      console.log('onend', arguments);
      isRecognizing = false;
      
      if (ignore_onend) {
        return false;
      }
      
      // do end process
      if (!final_transcript) {
        console.log('empty final_transcript');
        return false;
      }
      
      if (window.getSelection) {
        window.getSelection().removeAllRanges();
        var range = document.createRange();
        range.selectNode(document.getElementById('final_span'));
        window.getSelection().addRange(range);
      }
    };
  
    recognition.onresult = function(event) {
      console.log('onresult', event);
      
      var interim_transcript = '';
      if (typeof(event.results) == 'undefined') {
        recognition.onend = null;
        recognition.stop();
        return;
      }
      
      for (var i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          final_transcript += event.results[i][0].transcript;
        } else {
          interim_transcript += event.results[i][0].transcript;
        }
      }
      
      final_transcript = capitalize(final_transcript);
      final_span.innerHTML = linebreak(final_transcript);
      interim_span.innerHTML = linebreak(interim_transcript);
      
      console.log('final_transcript', final_transcript);
      console.log('interim_transcript', interim_transcript);
    };
  
    recognition.onerror = function(event) {
      console.log('onerror', event);

      if (event.error == 'no-speech') {
        ignore_onend = true;
      } else if (event.error == 'audio-capture') {
        ignore_onend = true;
      } else if (event.error == 'not-allowed') {
        ignore_onend = true;
      }
    };
    
    var two_line = /\n\n/g;
    var one_line = /\n/g;
    var first_char = /\S/;
    
    function linebreak(s) {
      return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
    }
    
    function capitalize(s) {
      return s.replace(first_char, function(m) { 
        return m.toUpperCase(); 
      });
    }
    
    function start(event) {
      if (isRecognizing) {
        recognition.stop();
        return;
      }
      recognition.lang = 'ko-KR';
      recognition.start();
      ignore_onend = false;
      
      final_transcript = '';
      final_span.innerHTML = '';
      interim_span.innerHTML = '';
    }
    
    /**
     * init 
     */ 
    $('#start').click(start);
  });
</script>

<% include global/footer.html %>

